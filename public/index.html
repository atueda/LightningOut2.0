<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Lightning Out 2.0 with OAuth</title>
</head>
<body>
    <h1>Lightning Out 2.0 (OAuthèªè¨¼ä»˜ã)</h1>

    <!-- æœªãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«è¡¨ç¤ºã™ã‚‹ã‚¨ãƒªã‚¢ -->
    <div id="auth-section">
        <h2>ğŸ” Salesforceèªè¨¼</h2>
        <p>Lightning Web Componentã‚’è¡¨ç¤ºã™ã‚‹ã«ã¯èªè¨¼ãŒå¿…è¦ã§ã™ã€‚</p>

        <div style="margin: 20px 0;">
            <button id="loginButton" style="padding: 12px 24px; margin: 5px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">âš¡ Lightning Out é–‹å§‹ (ã‚µãƒ¼ãƒãƒ¼èªè¨¼)</button>
            <button id="realAuthButton" style="padding: 12px 24px; margin: 5px; background: #1976d2; color: white; border: none; border-radius: 4px; cursor: pointer;">ğŸ” OAuthèªè¨¼</button>
        </div>

        <div style="margin: 20px 0; padding: 10px; border: 1px solid #4CAF50; border-radius: 4px; background: #e8f5e8;">
            <h4>âœ… æ¨å¥¨: å‹•ä½œç¢ºèªæ¸ˆã¿æ©Ÿèƒ½</h4>
            <p style="margin: 5px 0; font-size: 14px; color: #2e7d32;">ãƒˆãƒ¼ã‚¯ãƒ³ãƒ•ãƒ­ãƒ¼ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ãŸãŸã‚ã€åŒã˜æ–¹å¼ã‚’ä½¿ç”¨ã—ã¾ã™</p>
            <button id="testTokenFlow" style="padding: 8px 16px; margin: 3px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">ğŸ¯ å®Ÿè¨¼æ¸ˆã¿ãƒˆãƒ¼ã‚¯ãƒ³ãƒ•ãƒ­ãƒ¼</button>
        </div>

        <div style="margin: 20px 0; padding: 10px; border: 1px solid #17a2b8; border-radius: 4px; background: #d1ecf1;">
            <h4>ğŸ“Š ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹</h4>
            <button id="checkStatus" style="padding: 8px 16px; margin: 3px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer;">ğŸ” èªè¨¼çŠ¶æ…‹ç¢ºèª</button>
        </div>

        <div id="auth-status" style="margin: 15px 0; padding: 10px; border: 1px solid #ddd; border-radius: 4px; background: #f8f9fa; font-size: 14px;">
            èªè¨¼å¾…æ©Ÿä¸­...
        </div>
    </div>

    <!-- ãƒ­ã‚°ã‚¤ãƒ³å¾Œã«è¡¨ç¤ºã™ã‚‹ã‚¨ãƒªã‚¢ï¼ˆåˆæœŸçŠ¶æ…‹ã¯éè¡¨ç¤ºï¼‰ -->
    <div id="app-section" style="display:none;">
        <button id="sendMessageButton">LWCã¸ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡</button>
        <div id="lwcMessageResponse" style="margin-top: 10px; border: 1px solid #ccc; padding: 10px;">
            å¾…æ©Ÿä¸­...
        </div>
        <hr>
        
        <!-- Lightning Out 2.0 ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å®šç¾© -->
        <!-- frontdoor-url ã¯JSã§å‹•çš„ã«è¨­å®šã™ã‚‹ãŸã‚ã€åˆæœŸå€¤ã¯ç©ºã¾ãŸã¯ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ -->
        <lightning-out-application
            id="lightning-app"
            app-id="1UsHu000000oQTeKAM"
            components="c-card-component"
            style="width: 100%; height: 100%;"
        ></lightning-out-application>

        <!-- LWCã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ -->
        <c-card-component id="lwc-component" style="display: block; width: 100%; height: 800px; min-height: 400px;"></c-card-component>
    </div>

    <!-- ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ -->
    <script type="text/javascript" src="https://storm-f1b2bd8ede67bc.my.salesforce.com/lightning/lightning.out.latest/index.iife.prod.js"></script>
    <script>
        // --- è¨­å®šå€¤ï¼ˆã”è‡ªèº«ã®ç’°å¢ƒã«åˆã‚ã›ã¦å¤‰æ›´ã—ã¦ãã ã•ã„ï¼‰ ---
        // ã‚µãƒ¼ãƒå´ã§ Authorization Code Flow (/auth -> /callback?code=...) ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã€
        // ãƒ•ãƒ­ãƒ³ãƒˆã¯ /auth ã¸ã®é·ç§»ã®ã¿è¡Œã„ã€ãƒˆãƒ¼ã‚¯ãƒ³ã¯ /?token=..&instance=.. ã§å—é ˜ã—ã¦åˆ©ç”¨ã™ã‚‹ã€‚
        const MY_DOMAIN_URL = 'storm-f1b2bd8ede67bc.my.salesforce.com'; // My Domainã®URL

        // èªè¨¼çŠ¶æ…‹ç®¡ç†
        let authState = {
            isAuthenticated: false,
            token: null,
            instance: null
        };

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°é–¢æ•°
        function updateAuthStatus(message, type = 'info') {
            const statusEl = document.getElementById('auth-status');
            if (statusEl) {
                const colors = {
                    'info': '#d1ecf1',
                    'success': '#d4edda',
                    'error': '#f8d7da',
                    'warning': '#fff3cd'
                };
                statusEl.style.backgroundColor = colors[type] || colors.info;
                statusEl.textContent = message;
            }
            console.log(`[Auth Status] ${message}`);
        }

        document.addEventListener('DOMContentLoaded', () => {
            updateAuthStatus('ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº† - èªè¨¼çŠ¶æ³ã‚’ç¢ºèªä¸­...', 'info');

            // 1) ã‚µãƒ¼ãƒã‹ã‚‰ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼ˆ/?token=..&instance=..ï¼‰ã‚’æœ€å„ªå…ˆã§å‡¦ç†
            const search = new URLSearchParams(window.location.search);
            const tokenFromSearch = search.get('token');
            const instanceFromSearch = search.get('instance');

            if (tokenFromSearch) {
                console.group('ğŸ” Code Flow Result (server redirect)');
                console.info('Received token via query (masked):', maskToken(tokenFromSearch));
                console.info('Instance URL:', instanceFromSearch);

                authState.isAuthenticated = true;
                authState.token = tokenFromSearch;
                authState.instance = instanceFromSearch;

                updateAuthStatus('âœ… OAuthèªè¨¼æˆåŠŸ - Lightning OutåˆæœŸåŒ–ä¸­...', 'success');

                // UIåˆ‡æ›¿
                switchToAppSection();
                // ãƒãƒƒã‚·ãƒ¥ã¯ç©ºã«ã—ã¦ãŠãï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šæ¨å¥¨ï¼‰
                history.replaceState(null, null, window.location.pathname);
                // Lightning Out åˆæœŸåŒ–
                initLightningOut(tokenFromSearch);
                console.groupEnd();
                return;
            }

            // 2) äº’æ›: ã‚‚ã—ãƒãƒƒã‚·ãƒ¥(#access_token=...) ãŒã‚ã‚‹æ—§ãƒ•ãƒ­ãƒ¼ã®å ´åˆã¯ãƒ­ã‚°ã ã‘æ®‹ã™ï¼ˆåŸºæœ¬ã¯ä½¿ç”¨ã—ãªã„ï¼‰
            if (window.location.hash.includes('access_token')) {
                console.warn('Implicit Flow hash detected. This app uses Authorization Code Flow. Ignoring hash.');
                updateAuthStatus('âš ï¸ å¤ã„èªè¨¼æ–¹å¼ã‚’æ¤œå‡º - ç„¡è¦–ã—ã¾ã™', 'warning');
                // æ—§å®Ÿè£…äº’æ›ã§è¡¨ç¤ºã—ãŸã„å ´åˆã¯ä»¥ä¸‹ã‚’æœ‰åŠ¹åŒ–
                // const h = new URLSearchParams(window.location.hash.substring(1));
                // const accessToken = h.get('access_token');
                // if (accessToken) { switchToAppSection(); initLightningOut(accessToken); }
                history.replaceState(null, null, window.location.pathname);
            }

            // 3) ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
            const loginBtn = document.getElementById('loginButton');
            const realAuthBtn = document.getElementById('realAuthButton');
            const testTokenFlowBtn = document.getElementById('testTokenFlow');
            const checkStatusBtn = document.getElementById('checkStatus');

            // ãƒ¡ã‚¤ãƒ³èªè¨¼ãƒœã‚¿ãƒ³: æˆåŠŸã—ãŸãƒˆãƒ¼ã‚¯ãƒ³ãƒ•ãƒ­ãƒ¼ã¨åŒã˜å‡¦ç†
            if (loginBtn) {
                loginBtn.addEventListener('click', (event) => {
                    event.preventDefault();
                    console.log('âš¡ Lightning Out é–‹å§‹ (å‹•ä½œä¿è¨¼ç‰ˆ) ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
                    updateAuthStatus('âš¡ å‹•ä½œä¿è¨¼ç‰ˆã§Lightning Outã‚’é–‹å§‹ä¸­...', 'info');

                    // æˆåŠŸã—ãŸãƒˆãƒ¼ã‚¯ãƒ³ãƒ•ãƒ­ãƒ¼ãƒ†ã‚¹ãƒˆã¨åŒã˜å‡¦ç†ã‚’å®Ÿè¡Œ
                    executeLightningOutFlow();
                });

                console.log('âœ… ãƒ¡ã‚¤ãƒ³èªè¨¼ãƒœã‚¿ãƒ³ (å‹•ä½œä¿è¨¼ç‰ˆ) ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ãŒè¨­å®šã•ã‚Œã¾ã—ãŸ');
            }

            // æœ¬æ ¼OAuthèªè¨¼ãƒœã‚¿ãƒ³: å…ƒã®å‡¦ç†
            if (realAuthBtn) {
                realAuthBtn.addEventListener('click', (event) => {
                    event.preventDefault();
                    event.stopPropagation();

                    console.log('ğŸ” æœ¬æ ¼OAuthèªè¨¼ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
                    updateAuthStatus('ğŸ”„ OAuthèªè¨¼ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆä¸­...', 'info');

                    // ãƒœã‚¿ãƒ³ã‚’ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–
                    realAuthBtn.disabled = true;
                    realAuthBtn.textContent = 'ğŸ”„ èªè¨¼ä¸­...';

                    // å°‘ã—é…å»¶ã‚’å…¥ã‚Œã¦ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’è¦‹ã›ã‚‹ï¼‰
                    setTimeout(() => {
                        window.location.href = '/auth';
                    }, 500);
                });

                console.log('âœ… æœ¬æ ¼OAuthèªè¨¼ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ãŒè¨­å®šã•ã‚Œã¾ã—ãŸ');
            }



            // ãƒ‡ãƒãƒƒã‚°ãƒœã‚¿ãƒ³: ãƒˆãƒ¼ã‚¯ãƒ³ãƒ•ãƒ­ãƒ¼ãƒ†ã‚¹ãƒˆ
            if (testTokenFlowBtn) {
                testTokenFlowBtn.addEventListener('click', (event) => {
                    event.preventDefault();
                    console.log('ğŸ¯ ãƒˆãƒ¼ã‚¯ãƒ³ãƒ•ãƒ­ãƒ¼ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
                    testTokenFlow();
                });
                console.log('âœ… ãƒˆãƒ¼ã‚¯ãƒ³ãƒ•ãƒ­ãƒ¼ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ãŒè¨­å®šã•ã‚Œã¾ã—ãŸ');
            }

            // ãƒ‡ãƒãƒƒã‚°ãƒœã‚¿ãƒ³: çŠ¶æ…‹ç¢ºèª
            if (checkStatusBtn) {
                checkStatusBtn.addEventListener('click', (event) => {
                    event.preventDefault();
                    console.log('ğŸ“Š çŠ¶æ…‹ç¢ºèªãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
                    checkCurrentStatus();
                });
                console.log('âœ… çŠ¶æ…‹ç¢ºèªãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ãŒè¨­å®šã•ã‚Œã¾ã—ãŸ');
            }

            updateAuthStatus('ğŸ¯ ã™ã¹ã¦ã®ãƒœã‚¿ãƒ³æº–å‚™å®Œäº† - èªè¨¼ã¾ãŸã¯ãƒ‡ãƒãƒƒã‚°ã‚’é–‹å§‹', 'info');

            // Lightning Out ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®èª­ã¿è¾¼ã¿ç¢ºèªã¨å†è©¦è¡Œ
            function checkLightningOutScript() {
                if (window.LightningOut) {
                    console.log('âœ… Lightning Out ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒåˆ©ç”¨å¯èƒ½ã§ã™');
                    updateAuthStatus('âœ… Lightning Outã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿å®Œäº†', 'success');
                    return true;
                } else {
                    console.warn('âš ï¸ Lightning Out ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                    return false;
                }
            }

            // åˆå›ãƒã‚§ãƒƒã‚¯
            if (!checkLightningOutScript()) {
                updateAuthStatus('âš ï¸ Lightning Outã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿å¾…æ©Ÿä¸­...', 'warning');

                // é…å»¶å†ãƒã‚§ãƒƒã‚¯ï¼ˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã®èª­ã¿è¾¼ã¿å¾…æ©Ÿï¼‰
                let retryCount = 0;
                const maxRetries = 10;
                const checkInterval = setInterval(() => {
                    retryCount++;
                    console.log(`Lightning Outã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒã‚§ãƒƒã‚¯è©¦è¡Œ ${retryCount}/${maxRetries}`);

                    if (checkLightningOutScript()) {
                        clearInterval(checkInterval);
                        updateAuthStatus('âœ… Lightning Outã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿å®Œäº†ï¼ˆé…å»¶ï¼‰', 'success');
                    } else if (retryCount >= maxRetries) {
                        clearInterval(checkInterval);
                        console.error('âŒ Lightning Outã‚¹ã‚¯ãƒªãƒ—ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                        updateAuthStatus('âŒ Lightning Outã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿å¤±æ•— - æ‰‹å‹•ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„', 'error');
                    }
                }, 1000);
            }
        });

        function maskToken(v, show = 6) {
            return v ? (v.substring(0, show) + '...' + v.substring(v.length - 4)) : null;
        }

        function switchToAppSection() {
            console.log('ğŸ”„ switchToAppSection() ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã—ãŸ');
            const authEl = document.getElementById('auth-section');
            const appEl = document.getElementById('app-section');

            console.log('èªè¨¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¦ç´ :', authEl);
            console.log('ã‚¢ãƒ—ãƒªã‚»ã‚¯ã‚·ãƒ§ãƒ³è¦ç´ :', appEl);

            if (authEl) {
                authEl.style.display = 'none';
                console.log('âœ… èªè¨¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤ºã«ã—ã¾ã—ãŸ');
            } else {
                console.error('âŒ èªè¨¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }

            if (appEl) {
                appEl.style.display = 'block';
                console.log('âœ… ã‚¢ãƒ—ãƒªã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ');
                updateAuthStatus('âœ… ã‚¢ãƒ—ãƒªã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸï¼', 'success');
            } else {
                console.error('âŒ ã‚¢ãƒ—ãƒªã‚»ã‚¯ã‚·ãƒ§ãƒ³è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }
        }

        // ãƒ‡ãƒãƒƒã‚°é–¢æ•°: å¼·åˆ¶çš„ã«app-sectionã‚’è¡¨ç¤º
        function forceShowAppSection() {
            console.log('ğŸ§ª å¼·åˆ¶çš„ã«app-sectionã‚’è¡¨ç¤ºã—ã¾ã™');
            updateAuthStatus('ğŸ§ª ãƒ†ã‚¹ãƒˆ: app-sectionã‚’å¼·åˆ¶è¡¨ç¤ºä¸­...', 'warning');

            // ç›´æ¥DOMæ“ä½œã§app-sectionã‚’è¡¨ç¤º
            const authSection = document.getElementById('auth-section');
            const appSection = document.getElementById('app-section');

            console.log('èªè¨¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¦ç´ :', authSection);
            console.log('ã‚¢ãƒ—ãƒªã‚»ã‚¯ã‚·ãƒ§ãƒ³è¦ç´ :', appSection);

            if (authSection) {
                authSection.style.display = 'none';
                console.log('âœ… èªè¨¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤ºã«ã—ã¾ã—ãŸ');
            }

            if (appSection) {
                appSection.style.display = 'block';
                appSection.style.visibility = 'visible';
                appSection.style.opacity = '1';
                console.log('âœ… ã‚¢ãƒ—ãƒªã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ');
                updateAuthStatus('âœ… app-sectionå¼·åˆ¶è¡¨ç¤ºæˆåŠŸï¼', 'success');

                // Lightning Outè¦ç´ ã‚‚ç¢ºèª
                const lightningApp = document.getElementById('lightning-app');
                const lwcComponent = document.getElementById('lwc-component');

                console.log('Lightning Out Applicationè¦ç´ :', lightningApp);
                console.log('LWC Componentè¦ç´ :', lwcComponent);

                if (lightningApp || lwcComponent) {
                    updateAuthStatus('âœ… app-sectionè¡¨ç¤ºå®Œäº† - Lightning Outè¦ç´ ã‚‚ç™ºè¦‹', 'success');
                } else {
                    updateAuthStatus('âš ï¸ app-sectionè¡¨ç¤ºå®Œäº† - Lightning Outè¦ç´ ã¯è¦‹ã¤ã‹ã‚‰ãªã„', 'warning');
                }
            } else {
                console.error('âŒ ã‚¢ãƒ—ãƒªã‚»ã‚¯ã‚·ãƒ§ãƒ³è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                updateAuthStatus('âŒ app-sectionè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
            }
        }

        // çµ±åˆã•ã‚ŒãŸLightning Outãƒ•ãƒ­ãƒ¼å®Ÿè¡Œé–¢æ•°ï¼ˆæˆåŠŸãƒ‘ã‚¿ãƒ¼ãƒ³åŸºæº–ï¼‰
        async function executeLightningOutFlow() {
            console.log('âš¡ Lightning Out ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œé–‹å§‹');
            updateAuthStatus('âš¡ Lightning OutåˆæœŸåŒ–ãƒ•ãƒ­ãƒ¼é–‹å§‹...', 'info');

            try {
                // ã‚¹ãƒ†ãƒƒãƒ—1: ã‚µãƒ¼ãƒãƒ¼èªè¨¼ã‚’å®Ÿè¡Œ
                updateAuthStatus('ğŸ”„ ã‚µãƒ¼ãƒãƒ¼èªè¨¼ã‚’å®Ÿè¡Œä¸­...', 'info');
                const response = await fetch('/auth/server', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    const authData = await response.json();
                    console.log('âœ… ã‚µãƒ¼ãƒãƒ¼èªè¨¼æˆåŠŸ:', authData);

                    // èªè¨¼çŠ¶æ…‹ã‚’æ›´æ–°
                    authState.isAuthenticated = true;
                    authState.token = authData.accessToken || 'server_auth_token';
                    authState.instance = authData.instanceUrl;

                    updateAuthStatus('âœ… èªè¨¼å®Œäº† - Lightning OutåˆæœŸåŒ–ä¸­...', 'success');

                    // ã‚¹ãƒ†ãƒƒãƒ—2: app-sectionã‚’è¡¨ç¤º
                    switchToAppSection();

                    // ã‚¹ãƒ†ãƒƒãƒ—3: Lightning OutåˆæœŸåŒ–
                    initLightningOut(authState.token);

                    console.log('ğŸ‰ Lightning Out ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œå®Œäº†');
                    updateAuthStatus('ğŸ‰ Lightning Outèµ·å‹•å®Œäº†ï¼', 'success');

                } else {
                    throw new Error(`ã‚µãƒ¼ãƒãƒ¼èªè¨¼å¤±æ•—: ${response.status}`);
                }

            } catch (error) {
                console.error('âŒ Lightning Out ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œã‚¨ãƒ©ãƒ¼:', error);
                updateAuthStatus(`âŒ ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');

                // ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ†ã‚¹ãƒˆç”¨ãƒˆãƒ¼ã‚¯ãƒ³ã§å®Ÿè¡Œ
                console.log('âš ï¸ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ†ã‚¹ãƒˆç”¨ãƒˆãƒ¼ã‚¯ãƒ³ã§å®Ÿè¡Œ');
                updateAuthStatus('âš ï¸ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ†ã‚¹ãƒˆç”¨è¨­å®šã§å®Ÿè¡Œä¸­...', 'warning');

                const mockToken = 'fallback_token_12345';
                authState.isAuthenticated = true;
                authState.token = mockToken;
                authState.instance = 'https://storm-f1b2bd8ede67bc.my.salesforce.com';

                switchToAppSection();
                initLightningOut(mockToken);
            }
        }

        // ãƒ‡ãƒãƒƒã‚°é–¢æ•°: ãƒˆãƒ¼ã‚¯ãƒ³ãƒ•ãƒ­ãƒ¼ã‚’ãƒ†ã‚¹ãƒˆ
        function testTokenFlow() {
            console.log('ğŸ¯ ãƒˆãƒ¼ã‚¯ãƒ³ãƒ•ãƒ­ãƒ¼ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™');
            updateAuthStatus('ğŸ¯ ãƒ†ã‚¹ãƒˆ: æ¨¡æ“¬ãƒˆãƒ¼ã‚¯ãƒ³ã§ãƒ†ã‚¹ãƒˆä¸­...', 'info');

            // æ¨¡æ“¬ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨ã—ã¦ãƒ•ãƒ­ãƒ¼ã‚’ãƒ†ã‚¹ãƒˆ
            const mockToken = 'mock_token_for_testing_12345';
            authState.isAuthenticated = true;
            authState.token = mockToken;
            authState.instance = 'https://storm-f1b2bd8ede67bc.my.salesforce.com';

            switchToAppSection();
            initLightningOut(mockToken);
        }

        // ãƒ‡ãƒãƒƒã‚°é–¢æ•°: ç¾åœ¨ã®çŠ¶æ…‹ã‚’ç¢ºèª
        function checkCurrentStatus() {
            console.log('ğŸ“Š ç¾åœ¨ã®çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™');

            const authSection = document.getElementById('auth-section');
            const appSection = document.getElementById('app-section');

            console.group('ğŸ” ç¾åœ¨ã®çŠ¶æ…‹');
            console.log('èªè¨¼çŠ¶æ…‹:', authState);
            console.log('èªè¨¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤º:', authSection ? authSection.style.display : 'null');
            console.log('ã‚¢ãƒ—ãƒªã‚»ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤º:', appSection ? appSection.style.display : 'null');
            console.log('URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿:', window.location.search);
            console.log('Lightning Outåˆ©ç”¨å¯èƒ½:', !!window.LightningOut);
            console.groupEnd();

            const status = {
                'auth': authState.isAuthenticated ? 'âœ…' : 'âŒ',
                'authSection': authSection && authSection.style.display !== 'none' ? 'ğŸ‘ï¸' : 'ğŸ™ˆ',
                'appSection': appSection && appSection.style.display === 'block' ? 'ğŸ‘ï¸' : 'ğŸ™ˆ',
                'token': authState.token ? 'âœ…' : 'âŒ',
                'lightning': window.LightningOut ? 'âœ…' : 'âŒ'
            };

            updateAuthStatus(`çŠ¶æ…‹ç¢ºèª - èªè¨¼:${status.auth} èªè¨¼ç”»é¢:${status.authSection} ã‚¢ãƒ—ãƒªç”»é¢:${status.appSection} ãƒˆãƒ¼ã‚¯ãƒ³:${status.token} Lightning:${status.lightning}`, 'info');
        }

        // 3. Lightning Out 2.0 ã« frontdoor-url ã‚’è¨­å®šã—ã¦èµ·å‹•ã™ã‚‹é–¢æ•°
        function initLightningOut(token) {
            console.log('âš¡ Lightning OutåˆæœŸåŒ–é–‹å§‹...');
            updateAuthStatus('âš¡ Lightning OutåˆæœŸåŒ–ä¸­...', 'info');

            const app = document.querySelector('lightning-out-application');
            const lwcComponent = document.querySelector('c-card-component');

            console.log('Lightning Outè¦ç´ :', app);
            console.log('LWCã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè¦ç´ :', lwcComponent);

            if (!app) {
                console.error('âŒ lightning-out-application element not found');
                updateAuthStatus('âŒ Lightning Outè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                return;
            }

            // Lightning Outåˆ©ç”¨å¯èƒ½æ€§ãƒã‚§ãƒƒã‚¯
            if (!window.LightningOut) {
                console.warn('âš ï¸ Lightning Out ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                updateAuthStatus('âš ï¸ Lightning Outã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒå¿…è¦ã§ã™', 'warning');
            }

            // frontdoor-url ã®æ§‹ç¯‰ï¼ˆå¿…ãš https://<domain> ã‚’å«ã‚ã‚‹ï¼‰
            const domain = (MY_DOMAIN_URL.startsWith('http') ? MY_DOMAIN_URL : `https://${MY_DOMAIN_URL}`);
            const frontdoorUrl = `${domain}/secur/frontdoor.jsp?sid=${encodeURIComponent(token)}`;

            console.log('ğŸ”— frontdoor URLè¨­å®š:', {
                domain,
                tokenPreview: maskToken(token),
                frontdoorUrlPreview: `${frontdoorUrl.substring(0, 80)}...`
            });

            // Lightning Out 2.0 ã®åˆæœŸåŒ–ãƒ—ãƒ­ã‚»ã‚¹ã‚’æ­£ç¢ºã«å®Ÿè¡Œ
            try {
                // 1. frontdoor-url å±æ€§ã‚’è¨­å®š
                app.setAttribute('frontdoor-url', frontdoorUrl);
                console.log('âœ… frontdoor-urlå±æ€§ã‚’è¨­å®šã—ã¾ã—ãŸ');

                // 2. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã® ready ã‚¤ãƒ™ãƒ³ãƒˆã‚’å¾…ã¤
                app.addEventListener('lo.application.ready', () => {
                    console.log('ğŸ‰ Lightning Out Application is ready!');
                    updateAuthStatus('ğŸ‰ Lightning Outæº–å‚™å®Œäº†ï¼', 'success');
                    // 3. LWCã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®åˆæœŸåŒ–
                    setupEventHandlers(lwcComponent);
                });

                // 4. ã‚¨ãƒ©ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
                app.addEventListener('lo.application.error', (event) => {
                    console.error('âŒ Lightning Out Application error:', event.detail);
                    updateAuthStatus(`âŒ Lightning Outã‚¨ãƒ©ãƒ¼: ${JSON.stringify(event.detail)}`, 'error');
                });

                updateAuthStatus('âš¡ Lightning Outè¨­å®šå®Œäº† - ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•å¾…æ©Ÿä¸­...', 'info');
                console.log('âš¡ Lightning OutåˆæœŸåŒ–è¨­å®šå®Œäº†');

            } catch (error) {
                console.error('âŒ Lightning OutåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                updateAuthStatus(`âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã®è¨­å®šï¼ˆCSPå¯¾å¿œ: ã™ã¹ã¦ addEventListener ã§ç™»éŒ²ï¼‰
        function setupEventHandlers(lwcComponent) {
            const messageDisplay = document.getElementById('lwcMessageResponse');
            const sendButton = document.getElementById('sendMessageButton');

            if (!lwcComponent) {
                console.warn('LWC component not found for event wiring');
                return;
            }

            // LWCã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡
            lwcComponent.addEventListener('lwcMessageToHost', (event) => {
                console.log('LWCã‹ã‚‰å—ä¿¡:', event.detail);
                if (messageDisplay) {
                    messageDisplay.innerText = `å—ä¿¡: ${event.detail.message}`;
                }
            });

            // LWCã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
            if (sendButton) {
                sendButton.addEventListener('click', () => {
                    const ev = new CustomEvent('sendMessageToLWC', {
                        detail: { message: 'èªè¨¼æ¸ˆã¿ãƒ›ã‚¹ãƒˆã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸' },
                        bubbles: true,
                        composed: true // Shadow DOMå¢ƒç•Œã‚’è¶…ãˆã‚‹ãŸã‚ã«å¿…é ˆ
                    });
                    lwcComponent.dispatchEvent(ev);
                });
            }
        }
    </script>
</body>
</html>
